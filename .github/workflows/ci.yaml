# Copyright 2024 The TensorFlow Quantum Authors. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Summary: GitHub continuous integration workflow for TensorFlow Quantum.
#
# This workflow is executed on pull requests. It test and validates code
# changes before they are merged into the main codebase.
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

name: Continuous integration

on:
  pull_request:
  workflow_dispatch:
    save_artifacts:
      description: Save build artifacts & make them available for downloading.
      type: boolean

env:
  arch: x64
  py_version: '3.10'
  venv: ./.venv
  bazel_version: '6.5.0'
  save_artifacts: false

permissions:
  actions: write

run-name: Run CI for "${{github.event.pull_request.title || github.event.workflow_dispatch.display_title}}" by @${{github.triggering_actor}}
jobs:
  initialization:
    name: Initialize the workflow
    runs-on: ubuntu-20.04
    steps:
      # TODO: there's a lookup option to actions/cache
      - run: |
          echo "init_venv=not_done" >> $GITHUB_OUTPUT
          vkey="venv-python-${{env.py_version}}-${{runner.os}}-${{env.arch}}"
          echo "venv_key=$vkey" >> $GITHUB_OUTPUT

  virtualenv-setup:
    name: Create & cache Python environment
    needs: [initialization]
    if: needs.initialization.outputs.init_venv != 'done'
    runs-on: ubuntu-20.04
    steps:
      - name: Check out a copy of the TFQ git repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{env.py_version}}
          architecture: ${{env.arch}}

      - name: Set up a cache for the Python virtualenv
        uses: actions/cache@v4
        with:
          path: ${{env.venv}}
          key: ${{env.venv_key}}

      - name: Install Python dependencies into the virtualenv
        run: |
          set -x -e
          python -m venv ${{env.venv}}
          source ${{env.venv}}/bin/activate
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
          echo "PATH=$PATH" >> $GITHUB_ENV
          echo "init_venv=done" >> $GITHUB_ENV
          # Save information to the run log, in case it's needed for debugging.
          which python
          python --version
          python3 -c 'import site; print(site.getsitepackages())'
          python3 -c 'import tensorflow as tf; print(tf.version.VERSION)'

  build-tfq:
    name: Configure, build, & cache TFQ
    needs: [virtualenv-setup]
    runs-on: ubuntu-20.04
    steps:
      - name: Check out a copy of the TFQ git repository
        uses: actions/checkout@v4

      - name: Set up Bazel
        uses: bazel-contrib/setup-bazel@0.9.1
        env:
          USE_BAZEL_VERSION: ${{env.bazel_version}}
        with:
          # Avoid downloading Bazel every time.
          bazelisk-cache: true
          # Store build cache per workflow.
          disk-cache: ${{github.workflow}}
          # Cache external/  repositories.
          external-cache: true
          # Share repository cache between workflows.
          repository-cache: trie

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{env.py_version}}
          architecture: ${{env.arch}}

      - name: Restore cached Python virtualenv
        uses: actions/cache@v4
        with:
          path: ${{env.venv}}
          key: ${{env.venv_key}}

      - name: Activate the Python virtualenv for this job
        run: |
          source ${{env.venv}}/bin/activate
          set -x -e
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH
          echo "$GITHUB_PATH"

      - name: Configure and build TFQ
        # The bazel-cache action will save the .bazelrc file automatically.
        run: |
          set -x -e
          echo "Y\n" | ./configure.sh
          bazel build -c opt --cxxopt="-msse2" --cxxopt="-msse3" --cxxopt="-msse4" //tensorflow_quantum/...

  # lint:
  #   name: Lint check
  #   runs-on: ubuntu-20.04
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.10'
  #         architecture: 'x64'
  #     - name: Install Lint tools
  #       run: pip install --upgrade pip setuptools; pip install -r requirements.txt;
  #     - name: Lint All
  #       run: ./scripts/lint_all.sh

  # format:
  #   name: Formatting check
  #   runs-on: ubuntu-20.04

  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.10'
  #         architecture: 'x64'
  #     - name: Install Format tools
  #       run: pip install --upgrade pip setuptools; pip install -r requirements.txt; sudo apt-get install -y clang-format-6.0
  #     - name: Format Check
  #       run: ./scripts/format_check.sh

  # wheel-build:
  #   name: Wheel test
  #   runs-on: ubuntu-20.04

  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.10'
  #         architecture: 'x64'
  #     - name: Install Bazel on CI
  #       run: ./scripts/ci_install.sh
  #     - name: Configure CI TF
  #       run: echo "Y\n" | ./configure.sh
  #     - name: Build Wheel Test
  #       run: ./scripts/build_pip_package_test.sh
  #     - name: Test Wheel
  #       run: ./scripts/run_example.sh

  # bazel-tests:
  #   name: Library tests
  #   runs-on: ubuntu-20.04
  #   needs: [lint, format]

  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.10'
  #         architecture: 'x64'
  #     - name: Install Bazel on CI
  #       run: ./scripts/ci_install.sh
  #     - name: Configure CI TF
  #       run: echo "Y\n" | ./configure.sh
  #     - name: Full Library Test
  #       run: ./scripts/test_all.sh

  run-leak-tests:
    name: Test for memory leaks
    # needs: [lint, format]
    needs: [virtualenv-setup, build-tfq]
    runs-on: ubuntu-20.04

    steps:
      - name: Check out a copy of the TFQ git repository
        uses: actions/checkout@v4

      - name: Set up Bazel
        uses: bazel-contrib/setup-bazel@0.9.1
        env:
          USE_BAZEL_VERSION: ${{env.bazel_version}}
        with:
          # Avoid downloading Bazel every time.
          bazelisk-cache: true
          # Store build cache per workflow.
          disk-cache: ${{github.workflow}}
          # Share repository cache between workflows.
          repository-cache: true
          # Cache external/  repositories.
          external-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{env.py_version}}
          architecture: ${{env.arch}}

      - name: Restore cached Python virtualenv
        uses: actions/cache@v4
        with:
          path: ${{env.venv}}
          key: ${{env.venv_key}}

      - name: Activate the Python virtualenv for this job
        run: |
          source ${{env.venv}}/bin/activate
          set -x -e
          echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH
          echo "$GITHUB_PATH"

      # - name: Restore cached Python virtualenv
      #   uses: actions/cache/restore@v4
      #   with:
      #     path: ${{env.venv}}
      #     key: venv-${{env.py_version}}-${{env.arch}}-${{hashFiles('requirements.txt')}}
      #     enableCrossOsArchive: true
      # - run: |
      #     set -x -e
      #     source ${{env.venv}}/bin/activate
      #     echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH
      #     echo "$GITHUB_PATH"

      - name: Perform memory leakage test on qsim and TFQ src
        run: ./scripts/msan_test.sh 2>&1 | tee bazel-output.log
        continue-on-error: true

      # - name: Save Bazel output as downloadable artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: bazel-out
      #     retention-days: 14
      #     include-hidden-files: true
      #     path: |
      #       bazel-output.log
      #       /home/runner/.bazel/execroot/__main__/bazel-out/
      #       !/home/runner/.bazel/execroot/__main__/bazel-out/**/*.so
      #       !/home/runner/.bazel/execroot/__main__/bazel-out/**/*.o
      #       !/home/runner/.bazel/execroot/__main__/bazel-out/**/_objs
      #       !/home/runner/.bazel/execroot/__main__/bazel-out/**/_solib_k8

  # tutorials-test:
  #   name: Tutorial tests
  #   runs-on: ubuntu-20.04
  #   needs: [lint, format, wheel-build]

  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.10'
  #         architecture: 'x64'
  #     - name: Install notebook dependencies
  #       run: pip install --upgrade pip seaborn==0.10.0
  #     - name: Install Bazel on CI
  #       run: ./scripts/ci_install.sh
  #     - name: Configure CI TF
  #       run: echo "Y\n" | ./configure.sh
  #     - name: Build Wheel
  #       run: ./scripts/build_pip_package_test.sh
  #     - name: Test Notebooks
  #       run: ./scripts/ci_validate_tutorials.sh
